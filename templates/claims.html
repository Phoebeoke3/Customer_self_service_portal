{% extends "base.html" %}

{% block title %}Claims Management - SwissAxa Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-exclamation-triangle"></i> Claims Management
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">File a New Claim</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('file_claim') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="policy_id" class="form-label">Related Policy (Optional)</label>
                        <select class="form-select" id="policy_id" name="policy_id">
                            <option value="">None</option>
                            {% for policy in policies %}
                            <option value="{{ policy.id }}">{{ policy.policy_number }} - {{ policy.policy_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="damage_type" class="form-label">Damage Type</label>
                        <select class="form-select" id="damage_type" name="damage_type" required>
                            <option value="">Select...</option>
                            <option value="Vehicle Accident">Vehicle Accident</option>
                            <option value="Property Damage">Property Damage</option>
                            <option value="Theft">Theft</option>
                            <option value="Natural Disaster">Natural Disaster</option>
                            <option value="Medical">Medical</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Location Address</label>
                        <input type="text" class="form-control" id="address" name="address" placeholder="Enter address">
                        <small class="form-text text-muted">Or use the map below to set location</small>
                    </div>
                    <div class="mb-3">
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <label class="form-label">Location on Map</label>
                        <div id="map" style="height: 300px; border: 1px solid #ddd; border-radius: 5px;"></div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="getCurrentLocation()">
                            <i class="fas fa-location-arrow"></i> Use My Location
                        </button>
                    </div>
                    <div class="mb-3">
                        <label for="media" class="form-label">Upload Photos/Videos</label>
                        <input type="file" class="form-control" id="media" name="media" 
                               accept="image/*,video/*" multiple>
                        <small class="form-text text-muted">Upload photos or videos of the damage</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane"></i> File Claim
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">My Claims</h5>
            </div>
            <div class="card-body">
                {% if claims %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Claim Number</th>
                                <th>Damage Type</th>
                                <th>Description</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for claim in claims %}
                            <tr>
                                <td><strong>{{ claim.claim_number }}</strong></td>
                                <td>{{ claim.damage_type }}</td>
                                <td>{{ claim.description[:50] }}...</td>
                                <td>
                                    {% if claim.latitude and claim.longitude %}
                                    <a href="https://www.google.com/maps?q={{ claim.latitude }},{{ claim.longitude }}" 
                                       target="_blank">
                                        <i class="fas fa-map-marker-alt"></i> View Map
                                    </a>
                                    {% else %}
                                    {{ claim.address or 'N/A' }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'primary' if claim.status == 'submitted' else 'success' }}">
                                        {{ claim.status }}
                                    </span>
                                </td>
                                <td>{{ claim.submitted_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewClaim({{ claim.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-muted mb-3"></i>
                    <p class="text-muted">No claims filed yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>
<script>
    let map;
    let marker;
    
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 51.1657, lng: 10.4515 }, // Germany center
            zoom: 6
        });
        
        marker = new google.maps.Marker({
            map: map,
            draggable: true
        });
        
        map.addListener('click', function(e) {
            marker.setPosition(e.latLng);
            document.getElementById('latitude').value = e.latLng.lat();
            document.getElementById('longitude').value = e.latLng.lng();
        });
        
        marker.addListener('dragend', function(e) {
            document.getElementById('latitude').value = e.latLng.lat();
            document.getElementById('longitude').value = e.latLng.lng();
        });
    }
    
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                if (map) {
                    map.setCenter(pos);
                    marker.setPosition(pos);
                    document.getElementById('latitude').value = pos.lat;
                    document.getElementById('longitude').value = pos.lng;
                }
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }
    
    function viewClaim(claimId) {
        // View claim details
        alert('Claim details view - Implementation pending');
    }
</script>
{% endblock %}

